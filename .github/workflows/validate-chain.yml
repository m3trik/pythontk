name: Validate Publish Chain (Dry Run)

# This workflow validates the entire publish chain without making any changes.
# Trigger it manually from pythontk to test the full chain.

on:
  workflow_dispatch:
    inputs:
      validate_downstream:
        description: 'Validate downstream packages (uitk, mayatk, tentacle)'
        type: boolean
        default: true

jobs:
  validate-pythontk:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      would_publish: ${{ steps.check.outputs.would_publish }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install build twine
      
      - name: Install package
        run: pip install -e .
      
      - name: Get version
        id: version
        run: |
          VERSION=$(python -c "from pythontk import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if would publish
        id: check
        run: |
          PYPI_VERSION=$(pip index versions pythontk 2>/dev/null | grep -oP 'Available versions: \K[^,]+' || echo "none")
          if [ "${{ steps.version.outputs.version }}" != "$PYPI_VERSION" ]; then
            echo "would_publish=true" >> $GITHUB_OUTPUT
            echo "✅ pythontk v${{ steps.version.outputs.version }} WOULD be published (PyPI has: $PYPI_VERSION)"
          else
            echo "would_publish=false" >> $GITHUB_OUTPUT
            echo "⏭️ pythontk v${{ steps.version.outputs.version }} already on PyPI - would skip"
          fi
      
      - name: Test build
        run: |
          rm -rf dist build *.egg-info
          python -m build
          python -m twine check dist/*
          echo "✅ Build validation passed"

  validate-uitk:
    needs: validate-pythontk
    if: github.event.inputs.validate_downstream == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      would_publish: ${{ steps.check.outputs.would_publish }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          repository: m3trik/uitk
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install build twine pythontk
      
      - name: Check requirements alignment
        run: |
          echo "Checking if requirements.txt would need update..."
          UPSTREAM_VERSION="${{ needs.validate-pythontk.outputs.version }}"
          CURRENT_REQ=$(grep -oP 'pythontk==\K[0-9.]+' requirements.txt || echo "not pinned")
          
          if [ "$CURRENT_REQ" != "$UPSTREAM_VERSION" ]; then
            echo "⚠️ requirements.txt has pythontk==$CURRENT_REQ, would update to ==$UPSTREAM_VERSION"
          else
            echo "✅ requirements.txt already aligned with upstream"
          fi
      
      - name: Get version
        id: version
        run: |
          VERSION=$(grep -oP '__version__\s*=\s*["\x27]\K[^"\x27]+' uitk/__init__.py)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if would publish
        id: check
        run: |
          PYPI_VERSION=$(pip index versions uitk 2>/dev/null | grep -oP 'Available versions: \K[^,]+' || echo "none")
          UPSTREAM_CHANGED="${{ needs.validate-pythontk.outputs.would_publish }}"
          
          if [ "${{ steps.version.outputs.version }}" != "$PYPI_VERSION" ] || [ "$UPSTREAM_CHANGED" == "true" ]; then
            echo "would_publish=true" >> $GITHUB_OUTPUT
            echo "✅ uitk v${{ steps.version.outputs.version }} WOULD be published"
          else
            echo "would_publish=false" >> $GITHUB_OUTPUT
            echo "⏭️ uitk would skip"
          fi
      
      - name: Test build
        run: |
          rm -rf dist build *.egg-info
          python -m build
          python -m twine check dist/*
          echo "✅ Build validation passed"

  validate-mayatk:
    needs: [validate-pythontk, validate-uitk]
    if: github.event.inputs.validate_downstream == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      would_publish: ${{ steps.check.outputs.would_publish }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          repository: m3trik/mayatk
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install build twine pythontk uitk qtpy
      
      - name: Check requirements alignment
        run: |
          echo "Checking requirements.txt alignment..."
          
          PTK_UPSTREAM="${{ needs.validate-pythontk.outputs.version }}"
          PTK_REQ=$(grep -oP 'pythontk==\K[0-9.]+' requirements.txt || echo "not pinned")
          
          UITK_UPSTREAM="${{ needs.validate-uitk.outputs.version }}"
          UITK_REQ=$(grep -oP 'uitk==\K[0-9.]+' requirements.txt || echo "not pinned")
          
          if [ "$PTK_REQ" != "$PTK_UPSTREAM" ]; then
            echo "⚠️ pythontk: $PTK_REQ → $PTK_UPSTREAM"
          fi
          if [ "$UITK_REQ" != "$UITK_UPSTREAM" ]; then
            echo "⚠️ uitk: $UITK_REQ → $UITK_UPSTREAM"
          fi
      
      - name: Get version
        id: version
        run: |
          VERSION=$(grep -oP '__version__\s*=\s*["\x27]\K[^"\x27]+' mayatk/__init__.py)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if would publish
        id: check
        run: |
          PYPI_VERSION=$(pip index versions mayatk 2>/dev/null | grep -oP 'Available versions: \K[^,]+' || echo "none")
          UPSTREAM_CHANGED="${{ needs.validate-uitk.outputs.would_publish }}"
          
          if [ "${{ steps.version.outputs.version }}" != "$PYPI_VERSION" ] || [ "$UPSTREAM_CHANGED" == "true" ]; then
            echo "would_publish=true" >> $GITHUB_OUTPUT
            echo "✅ mayatk v${{ steps.version.outputs.version }} WOULD be published"
          else
            echo "would_publish=false" >> $GITHUB_OUTPUT
            echo "⏭️ mayatk would skip"
          fi
      
      - name: Test build
        run: |
          rm -rf dist build *.egg-info
          python -m build
          python -m twine check dist/*
          echo "✅ Build validation passed"

  validate-tentacle:
    needs: [validate-pythontk, validate-uitk, validate-mayatk]
    if: github.event.inputs.validate_downstream == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          repository: m3trik/tentacle
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install build twine pythontk uitk mayatk qtpy
      
      - name: Check requirements alignment
        run: |
          echo "Checking requirements.txt alignment..."
          
          PTK_UPSTREAM="${{ needs.validate-pythontk.outputs.version }}"
          PTK_REQ=$(grep -oP 'pythontk==\K[0-9.]+' requirements.txt || echo "not pinned")
          
          UITK_UPSTREAM="${{ needs.validate-uitk.outputs.version }}"
          UITK_REQ=$(grep -oP 'uitk==\K[0-9.]+' requirements.txt || echo "not pinned")
          
          MAYATK_UPSTREAM="${{ needs.validate-mayatk.outputs.version }}"
          MAYATK_REQ=$(grep -oP 'mayatk==\K[0-9.]+' requirements.txt || echo "not pinned")
          
          if [ "$PTK_REQ" != "$PTK_UPSTREAM" ]; then
            echo "⚠️ pythontk: $PTK_REQ → $PTK_UPSTREAM"
          fi
          if [ "$UITK_REQ" != "$UITK_UPSTREAM" ]; then
            echo "⚠️ uitk: $UITK_REQ → $UITK_UPSTREAM"
          fi
          if [ "$MAYATK_REQ" != "$MAYATK_UPSTREAM" ]; then
            echo "⚠️ mayatk: $MAYATK_REQ → $MAYATK_UPSTREAM"
          fi
      
      - name: Get version
        id: version
        run: |
          VERSION=$(grep -oP '__version__\s*=\s*["\x27]\K[^"\x27]+' tentacle/__init__.py)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if would publish
        run: |
          PYPI_VERSION=$(pip index versions tentacletk 2>/dev/null | grep -oP 'Available versions: \K[^,]+' || echo "none")
          UPSTREAM_CHANGED="${{ needs.validate-mayatk.outputs.would_publish }}"
          
          if [ "${{ steps.version.outputs.version }}" != "$PYPI_VERSION" ] || [ "$UPSTREAM_CHANGED" == "true" ]; then
            echo "✅ tentacletk v${{ steps.version.outputs.version }} WOULD be published"
          else
            echo "⏭️ tentacletk would skip"
          fi
      
      - name: Test build
        run: |
          rm -rf dist build *.egg-info
          python -m build
          python -m twine check dist/*
          echo "✅ Build validation passed"

  summary:
    needs: [validate-pythontk, validate-uitk, validate-mayatk, validate-tentacle]
    if: always() && github.event.inputs.validate_downstream == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Print summary
        run: |
          echo "============================================"
          echo "  PUBLISH CHAIN VALIDATION SUMMARY"
          echo "============================================"
          echo ""
          echo "pythontk  v${{ needs.validate-pythontk.outputs.version }} - would_publish: ${{ needs.validate-pythontk.outputs.would_publish }}"
          echo "uitk      v${{ needs.validate-uitk.outputs.version }} - would_publish: ${{ needs.validate-uitk.outputs.would_publish }}"
          echo "mayatk    v${{ needs.validate-mayatk.outputs.version }} - would_publish: ${{ needs.validate-mayatk.outputs.would_publish }}"
          echo "tentacle  - see job output"
          echo ""
          echo "If all builds passed, the chain is ready to publish."
